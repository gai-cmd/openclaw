# ì¹¸ë°˜ì°¨íŠ¸ ë°ì´í„° ìŠ¤í‚¤ë§ˆ ì„¤ê³„ì„œ

> ë²„ì „: v1.0 | ì‘ì„±ì¼: 2026-02-11 | ì‘ì„±: ë‚˜ë˜(CS)
> ê¸°ë°˜ ë¬¸ì„œ: ì¹¸ë°˜ì°¨íŠ¸_ì‹œìŠ¤í…œ_ì„¤ê³„ì„œ.md (ì„¹ì…˜ 8)

---

## 1. ì„¤ê³„ ì›ì¹™

- **ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ í™•ì¥**: í˜„ì¬ `src/db/schema.ts`ì˜ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì¹¸ë°˜ ì „ìš© í•„ë“œ ì¶”ê°€
- **í•˜ìœ„ í˜¸í™˜ì„±**: ê¸°ì¡´ `projects`, `tasks` í…Œì´ë¸” êµ¬ì¡° ë³´ì¡´, ìƒˆ ì»¬ëŸ¼ì€ nullable ë˜ëŠ” default ê°’ ì§€ì •
- **Drizzle ORM + PostgreSQL**: ê¸°ì¡´ ì¸í”„ë¼(pg-core) ê·¸ëŒ€ë¡œ í™œìš©
- **Enum ì¼ê´€ì„±**: ì„¤ê³„ì„œì˜ Phase/Domain/Status ì²´ê³„ë¥¼ pgEnumìœ¼ë¡œ ì •ì˜

---

## 2. Enum ì •ì˜

### 2.1 Phase (í”„ë¡œì íŠ¸ ì§„í–‰ ë‹¨ê³„)

```typescript
export const phaseEnum = pgEnum('phase', [
  'P0',  // ê¸°íš
  'P1',  // ì„¤ê³„
  'P2',  // ê°œë°œ
  'P3',  // ê²€ì¦
  'P4',  // ìš´ì˜
]);
```

### 2.2 Domain (ì‘ì—… ì˜ì—­)

```typescript
export const domainEnum = pgEnum('domain', [
  'DOC',  // ë¬¸ì„œ/ê¸°íš
  'UI',   // UI/UX ë””ìì¸
  'FE',   // í”„ë¡ íŠ¸ì—”ë“œ
  'BE',   // ë°±ì—”ë“œ/API
  'DB',   // ë°ì´í„°ë² ì´ìŠ¤
  'QA',   // í…ŒìŠ¤íŠ¸/ê²€ì¦
  'OPS',  // DevOps/ë°°í¬
  'MKT',  // ë§ˆì¼€íŒ…/ì½˜í…ì¸ 
]);
```

### 2.3 Agent (ì—ì´ì „íŠ¸)

```typescript
export const agentEnum = pgEnum('agent', [
  'po',        // ì´ë ˆ
  'dev',       // ë‹¤ì˜¨
  'design',    // ì±„ì•„
  'cs',        // ë‚˜ë˜
  'marketing', // ì•Œë¦¬
]);
```

### 2.4 Task Status (ì¹¸ë°˜ ì»¬ëŸ¼)

```typescript
export const taskStatusEnum = pgEnum('task_status', [
  'backlog',      // â¬œ ë“±ë¡ë¨, ë¯¸ë°°ì •
  'todo',         // ğŸŸ¦ ë°°ì •ë¨, ì‹œì‘ ëŒ€ê¸°
  'in_progress',  // ğŸŸ¨ ì§„í–‰ ì¤‘
  'review',       // ğŸŸª ê²€ì¦/ë¦¬ë·° ëŒ€ê¸°
  'done',         // ğŸŸ© ì™„ë£Œ
  'blocked',      // ğŸŸ¥ ì°¨ë‹¨ë¨
]);
```

### 2.5 Priority (ìš°ì„ ìˆœìœ„)

```typescript
export const priorityEnum = pgEnum('priority', [
  'critical',
  'high',
  'medium',
  'low',
]);
```

### 2.6 Verification Status (ê²€ì¦ ìƒíƒœ)

```typescript
export const verificationEnum = pgEnum('verification_status', [
  'not_verified',
  'passed',
  'failed',
]);
```

### 2.7 Gate Status (ê´€ë¬¸ ìƒíƒœ)

```typescript
export const gateStatusEnum = pgEnum('gate_status', [
  'not_started',
  'ai_verified',
  'po_approved',
  'rejected',
]);
```

### 2.8 Activity Action (í™œë™ ìœ í˜•)

```typescript
export const activityActionEnum = pgEnum('activity_action', [
  'created',
  'status_changed',
  'assigned',
  'commented',
  'progress_updated',
  'file_added',
  'gate_requested',
  'gate_verified',
  'gate_approved',
  'gate_rejected',
]);
```

---

## 3. í…Œì´ë¸” ì„¤ê³„

### 3.1 projects (í”„ë¡œì íŠ¸) â€” ê¸°ì¡´ í™•ì¥

```typescript
export const projects = pgTable('projects', {
  // === ê¸°ì¡´ í•„ë“œ (ìœ ì§€) ===
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull(),
  description: text('description'),
  createdAt: timestamp('created_at').defaultNow().notNull(),

  // === ì¹¸ë°˜ í™•ì¥ í•„ë“œ ===
  code: text('code').notNull().unique(),              // KAN, FXT, LIO, TRL, CRM
  currentPhase: phaseEnum('current_phase').default('P0'),
  status: text('status').default('active'),            // active / archived / paused
  leadAgent: agentEnum('lead_agent').default('po'),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ:**
- ê¸°ì¡´ `projects` í…Œì´ë¸”ì— `ALTER TABLE ADD COLUMN` ì ìš©
- `code`ëŠ” NOT NULLì´ë¯€ë¡œ, ê¸°ì¡´ ë ˆì½”ë“œê°€ ìˆìœ¼ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ë³¸ê°’ ì„¸íŒ… í•„ìš”

### 3.2 tasks (ì‘ì—…) â€” ê¸°ì¡´ í™•ì¥

```typescript
export const tasks = pgTable('tasks', {
  // === ê¸°ì¡´ í•„ë“œ (ìœ ì§€) ===
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id').references(() => projects.id),
  title: text('title').notNull(),
  description: text('description').notNull(),
  assignee: agentEnum('assignee').notNull(),
  status: taskStatusEnum('status').notNull().default('backlog'),
  dependencies: jsonb('dependencies').$type<string[]>().default([]),
  result: text('result'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  completedAt: timestamp('completed_at'),

  // === ì¹¸ë°˜ í™•ì¥ í•„ë“œ ===
  taskId: text('task_id').unique(),                    // KAN-P2FE-001 í˜•ì‹
  phase: phaseEnum('phase').notNull().default('P0'),
  domain: domainEnum('domain').notNull().default('DOC'),
  project: text('project'),                            // í”„ë¡œì íŠ¸ ì½”ë“œ (ì—­ì •ê·œí™”, ë¹ ë¥¸ ì¡°íšŒìš©)
  priority: priorityEnum('priority').default('medium'),
  progress: integer('progress').default(0),            // 0~100
  dueDate: timestamp('due_date'),

  // ê²€ì¦ ì •ë³´
  verificationStatus: verificationEnum('verification_status').default('not_verified'),
  testResult: text('test_result'),
  reviewNotes: text('review_notes'),
  blockers: text('blockers'),

  // ì¶”ì  ì •ë³´
  createdBy: agentEnum('created_by').default('po'),
  outputFiles: jsonb('output_files').$type<string[]>().default([]),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

**ë³€ê²½ ì‚¬í•­:**
- `graphId` ì œê±° â†’ `taskId`ë¡œ ëŒ€ì²´ (ì¹¸ë°˜ ID ì²´ê³„)
- `phase` íƒ€ì…: `integer` â†’ `phaseEnum` (P0~P4 ë¬¸ìì—´)
- `status`: ê¸°ì¡´ `pending/in_progress/completed/failed` â†’ ì¹¸ë°˜ 6ìƒíƒœë¡œ í™•ì¥
- `assignee`: `text` â†’ `agentEnum`
- ê²€ì¦/ì¶”ì  í•„ë“œ ì‹ ê·œ ì¶”ê°€

**ì¸ë±ìŠ¤:**

```typescript
// ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ íŒ¨í„´ì— ëŒ€í•œ ì¸ë±ìŠ¤
export const tasksTaskIdIdx = index('tasks_task_id_idx').on(tasks.taskId);
export const tasksStatusIdx = index('tasks_status_idx').on(tasks.status);
export const tasksProjectPhaseIdx = index('tasks_project_phase_idx').on(tasks.project, tasks.phase);
export const tasksAssigneeIdx = index('tasks_assignee_idx').on(tasks.assignee);
```

### 3.3 stage_gates (ë‹¨ê³„ ê´€ë¬¸) â€” ì‹ ê·œ

```typescript
export const stageGates = pgTable('stage_gates', {
  id: uuid('id').primaryKey().defaultRandom(),
  projectId: uuid('project_id').references(() => projects.id).notNull(),
  phase: phaseEnum('phase').notNull(),
  gateStatus: gateStatusEnum('gate_status').default('not_started').notNull(),
  aiResult: jsonb('ai_result').$type<{
    totalTasks: number;
    completedTasks: number;
    passRate: number;
    issues: string[];
    recommendation: 'pass' | 'fail' | 'conditional';
  }>(),
  poNotes: text('po_notes'),
  verifiedAt: timestamp('verified_at'),
  approvedAt: timestamp('approved_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  // í”„ë¡œì íŠ¸+ë‹¨ê³„ ì¡°í•©ì€ ê³ ìœ 
  projectPhaseUnique: unique().on(table.projectId, table.phase),
}));
```

### 3.4 activity_log (í™œë™ ë¡œê·¸) â€” ì‹ ê·œ

```typescript
export const activityLog = pgTable('activity_log', {
  id: uuid('id').primaryKey().defaultRandom(),
  taskId: uuid('task_id').references(() => tasks.id),
  agent: agentEnum('agent').notNull(),
  action: activityActionEnum('action').notNull(),
  details: jsonb('details').$type<{
    from?: string;         // ì´ì „ ìƒíƒœ
    to?: string;           // ë³€ê²½ í›„ ìƒíƒœ
    comment?: string;      // ì½”ë©˜íŠ¸
    files?: string[];      // ê´€ë ¨ íŒŒì¼
    metadata?: Record<string, unknown>;
  }>(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

**ì¸ë±ìŠ¤:**

```typescript
export const activityLogTaskIdx = index('activity_log_task_idx').on(activityLog.taskId);
export const activityLogCreatedIdx = index('activity_log_created_idx').on(activityLog.createdAt);
```

### 3.5 api_usage (API ì‚¬ìš©ëŸ‰ ì¶”ì ) â€” ì‹ ê·œ

```typescript
export const apiUsage = pgTable('api_usage', {
  id: uuid('id').primaryKey().defaultRandom(),
  agent: agentEnum('agent').notNull(),
  provider: text('provider').notNull(),   // openai / anthropic / gemini
  model: text('model').notNull(),         // gpt-4o / claude-sonnet / gemini-pro
  tokensInput: integer('tokens_input').default(0),
  tokensOutput: integer('tokens_output').default(0),
  costEstimate: integer('cost_estimate').default(0), // ì„¼íŠ¸ ë‹¨ìœ„ (ì†Œìˆ˜ì  íšŒí”¼)
  taskId: uuid('task_id').references(() => tasks.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

**ì¸ë±ìŠ¤:**

```typescript
export const apiUsageAgentIdx = index('api_usage_agent_idx').on(apiUsage.agent);
export const apiUsageCreatedIdx = index('api_usage_created_idx').on(apiUsage.createdAt);
```

### 3.6 messages (ë©”ì‹œì§€) â€” ê¸°ì¡´ ìœ ì§€

```typescript
// ë³€ê²½ ì—†ìŒ - ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€
export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  taskId: uuid('task_id').references(() => tasks.id),
  channelId: text('channel_id').notNull(),
  sender: text('sender').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

### 3.7 agent_contexts (ì—ì´ì „íŠ¸ ì»¨í…ìŠ¤íŠ¸) â€” ê¸°ì¡´ ìœ ì§€

```typescript
// ë³€ê²½ ì—†ìŒ - ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€
export const agentContexts = pgTable('agent_contexts', {
  id: uuid('id').primaryKey().defaultRandom(),
  agentType: text('agent_type').notNull(),
  projectId: uuid('project_id').references(() => projects.id),
  contextData: jsonb('context_data').$type<Record<string, unknown>>().default({}),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

---

## 4. ë¦´ë ˆì´ì…˜ (Relations) ì •ì˜

```typescript
import { relations } from 'drizzle-orm';

export const projectsRelations = relations(projects, ({ many }) => ({
  tasks: many(tasks),
  stageGates: many(stageGates),
}));

export const tasksRelations = relations(tasks, ({ one, many }) => ({
  project: one(projects, {
    fields: [tasks.projectId],
    references: [projects.id],
  }),
  activities: many(activityLog),
  apiUsages: many(apiUsage),
}));

export const stageGatesRelations = relations(stageGates, ({ one }) => ({
  project: one(projects, {
    fields: [stageGates.projectId],
    references: [projects.id],
  }),
}));

export const activityLogRelations = relations(activityLog, ({ one }) => ({
  task: one(tasks, {
    fields: [activityLog.taskId],
    references: [tasks.id],
  }),
}));

export const apiUsageRelations = relations(apiUsage, ({ one }) => ({
  task: one(tasks, {
    fields: [apiUsage.taskId],
    references: [tasks.id],
  }),
}));
```

---

## 5. ER ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   projects   â”‚â”€â”€1:Nâ”€â”€â”‚      tasks       â”‚â”€â”€1:Nâ”€â”€â”‚ activity_log  â”‚
â”‚              â”‚       â”‚                  â”‚       â”‚               â”‚
â”‚ id (PK)      â”‚       â”‚ id (PK)          â”‚       â”‚ id (PK)       â”‚
â”‚ code (UQ)    â”‚       â”‚ task_id (UQ)     â”‚       â”‚ task_id (FK)  â”‚
â”‚ name         â”‚       â”‚ project_id (FK)  â”‚       â”‚ agent         â”‚
â”‚ current_phaseâ”‚       â”‚ phase            â”‚       â”‚ action        â”‚
â”‚ lead_agent   â”‚       â”‚ domain           â”‚       â”‚ details       â”‚
â”‚ status       â”‚       â”‚ assignee         â”‚       â”‚ created_at    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ status           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚ priority         â”‚
       â”‚               â”‚ progress         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚ verification_    â”‚â”€â”€1:Nâ”€â”€â”‚  api_usage    â”‚
       â”‚               â”‚   status         â”‚       â”‚               â”‚
       â”‚               â”‚ output_files     â”‚       â”‚ id (PK)       â”‚
       â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ task_id (FK)  â”‚
       â”‚                                          â”‚ agent         â”‚
       â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ provider      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€1:Nâ”€â”€â”€â”€â”€â”‚   stage_gates    â”‚       â”‚ model         â”‚
                       â”‚                  â”‚       â”‚ tokens_input  â”‚
                       â”‚ id (PK)          â”‚       â”‚ tokens_output â”‚
                       â”‚ project_id (FK)  â”‚       â”‚ cost_estimate â”‚
                       â”‚ phase            â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ gate_status      â”‚
                       â”‚ ai_result        â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ po_notes         â”‚       â”‚   messages    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ (ê¸°ì¡´ ìœ ì§€)    â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚agent_contexts â”‚
                                                  â”‚ (ê¸°ì¡´ ìœ ì§€)    â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´

### 6.1 ì¹¸ë°˜ ë³´ë“œ ì¡°íšŒ (í”„ë¡œì íŠ¸ë³„)

```typescript
// í”„ë¡œì íŠ¸ì˜ ëª¨ë“  Taskë¥¼ ìƒíƒœë³„ë¡œ ê·¸ë£¹í™”
const boardTasks = await db.select()
  .from(tasks)
  .where(eq(tasks.project, 'KAN'))
  .orderBy(tasks.priority, tasks.createdAt);
```

### 6.2 íŒ€ì› ì›Œí¬ë¡œë“œ ì¡°íšŒ

```typescript
// ì—ì´ì „íŠ¸ë³„ ì§„í–‰ ì¤‘ì¸ Task ìˆ˜
const workload = await db.select({
  assignee: tasks.assignee,
  count: count(),
}).from(tasks)
  .where(inArray(tasks.status, ['todo', 'in_progress', 'review']))
  .groupBy(tasks.assignee);
```

### 6.3 Phaseë³„ ì§„í–‰ë¥  ê³„ì‚°

```typescript
// íŠ¹ì • í”„ë¡œì íŠ¸ì˜ Phaseë³„ ì™„ë£Œìœ¨
const phaseProgress = await db.select({
  phase: tasks.phase,
  total: count(),
  done: count(sql`CASE WHEN ${tasks.status} = 'done' THEN 1 END`),
}).from(tasks)
  .where(eq(tasks.project, 'KAN'))
  .groupBy(tasks.phase);
```

### 6.4 API ì‚¬ìš©ëŸ‰ ì§‘ê³„ (ì¼ë³„)

```typescript
// ì—ì´ì „íŠ¸ë³„ ì¼ì¼ í† í° ì‚¬ìš©ëŸ‰
const dailyUsage = await db.select({
  agent: apiUsage.agent,
  date: sql`DATE(${apiUsage.createdAt})`,
  totalInput: sum(apiUsage.tokensInput),
  totalOutput: sum(apiUsage.tokensOutput),
  totalCost: sum(apiUsage.costEstimate),
}).from(apiUsage)
  .groupBy(apiUsage.agent, sql`DATE(${apiUsage.createdAt})`);
```

### 6.5 ìµœê·¼ í™œë™ íƒ€ì„ë¼ì¸

```typescript
// ìµœê·¼ 20ê°œ í™œë™
const recentActivity = await db.select()
  .from(activityLog)
  .orderBy(desc(activityLog.createdAt))
  .limit(20);
```

---

## 7. ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### Step 1: Enum ìƒì„±
```sql
CREATE TYPE phase AS ENUM ('P0', 'P1', 'P2', 'P3', 'P4');
CREATE TYPE domain AS ENUM ('DOC', 'UI', 'FE', 'BE', 'DB', 'QA', 'OPS', 'MKT');
CREATE TYPE agent AS ENUM ('po', 'dev', 'design', 'cs', 'marketing');
CREATE TYPE task_status AS ENUM ('backlog', 'todo', 'in_progress', 'review', 'done', 'blocked');
CREATE TYPE priority AS ENUM ('critical', 'high', 'medium', 'low');
CREATE TYPE verification_status AS ENUM ('not_verified', 'passed', 'failed');
CREATE TYPE gate_status AS ENUM ('not_started', 'ai_verified', 'po_approved', 'rejected');
CREATE TYPE activity_action AS ENUM ('created', 'status_changed', 'assigned', 'commented', 'progress_updated', 'file_added', 'gate_requested', 'gate_verified', 'gate_approved', 'gate_rejected');
```

### Step 2: projects í…Œì´ë¸” í™•ì¥
```sql
ALTER TABLE projects ADD COLUMN code TEXT UNIQUE;
ALTER TABLE projects ADD COLUMN current_phase phase DEFAULT 'P0';
ALTER TABLE projects ADD COLUMN status TEXT DEFAULT 'active';
ALTER TABLE projects ADD COLUMN lead_agent agent DEFAULT 'po';
ALTER TABLE projects ADD COLUMN updated_at TIMESTAMP DEFAULT NOW();
-- ê¸°ì¡´ ë ˆì½”ë“œì— code ê°’ ì„¸íŒ… í›„
ALTER TABLE projects ALTER COLUMN code SET NOT NULL;
```

### Step 3: tasks í…Œì´ë¸” í™•ì¥
```sql
ALTER TABLE tasks ADD COLUMN task_id TEXT UNIQUE;
ALTER TABLE tasks ADD COLUMN domain domain DEFAULT 'DOC';
ALTER TABLE tasks ADD COLUMN project TEXT;
ALTER TABLE tasks ADD COLUMN priority priority DEFAULT 'medium';
ALTER TABLE tasks ADD COLUMN progress INTEGER DEFAULT 0;
ALTER TABLE tasks ADD COLUMN due_date TIMESTAMP;
ALTER TABLE tasks ADD COLUMN verification_status verification_status DEFAULT 'not_verified';
ALTER TABLE tasks ADD COLUMN test_result TEXT;
ALTER TABLE tasks ADD COLUMN review_notes TEXT;
ALTER TABLE tasks ADD COLUMN blockers TEXT;
ALTER TABLE tasks ADD COLUMN created_by agent DEFAULT 'po';
ALTER TABLE tasks ADD COLUMN output_files JSONB DEFAULT '[]';
ALTER TABLE tasks ADD COLUMN updated_at TIMESTAMP DEFAULT NOW();
-- phase ì»¬ëŸ¼ íƒ€ì… ë³€ê²½: integer â†’ phase enum
ALTER TABLE tasks ALTER COLUMN phase TYPE phase USING
  CASE phase WHEN 1 THEN 'P0' WHEN 2 THEN 'P1' WHEN 3 THEN 'P2' WHEN 4 THEN 'P3' WHEN 5 THEN 'P4' ELSE 'P0' END::phase;
-- status ì»¬ëŸ¼ íƒ€ì… ë³€ê²½: text â†’ task_status enum
ALTER TABLE tasks ALTER COLUMN status TYPE task_status USING
  CASE status WHEN 'pending' THEN 'backlog' WHEN 'in_progress' THEN 'in_progress' WHEN 'completed' THEN 'done' WHEN 'failed' THEN 'blocked' ELSE 'backlog' END::task_status;
-- graph_id ì»¬ëŸ¼ ì œê±°
ALTER TABLE tasks DROP COLUMN IF EXISTS graph_id;
```

### Step 4: ìƒˆ í…Œì´ë¸” ìƒì„±
```sql
CREATE TABLE stage_gates ( ... );  -- ì„¹ì…˜ 3.3 ì°¸ì¡°
CREATE TABLE activity_log ( ... ); -- ì„¹ì…˜ 3.4 ì°¸ì¡°
CREATE TABLE api_usage ( ... );    -- ì„¹ì…˜ 3.5 ì°¸ì¡°
```

### Step 5: ì¸ë±ìŠ¤ ìƒì„±
```sql
CREATE INDEX tasks_task_id_idx ON tasks (task_id);
CREATE INDEX tasks_status_idx ON tasks (status);
CREATE INDEX tasks_project_phase_idx ON tasks (project, phase);
CREATE INDEX tasks_assignee_idx ON tasks (assignee);
CREATE INDEX activity_log_task_idx ON activity_log (task_id);
CREATE INDEX activity_log_created_idx ON activity_log (created_at);
CREATE INDEX api_usage_agent_idx ON api_usage (agent);
CREATE INDEX api_usage_created_idx ON api_usage (created_at);
```

---

## 8. Task ID ìë™ ìƒì„± ë¡œì§

```typescript
/**
 * Task ID ìë™ ìƒì„±
 * í˜•ì‹: [í”„ë¡œì íŠ¸ì½”ë“œ]-[Phase][Domain]-[ìˆœë²ˆ(3ìë¦¬)]
 * ì˜ˆ: KAN-P2FE-001
 */
async function generateTaskId(
  projectCode: string,
  phase: string,
  domain: string,
): Promise<string> {
  const prefix = `${projectCode}-${phase}${domain}`;

  // ê°™ì€ prefixì˜ ë§ˆì§€ë§‰ ìˆœë²ˆ ì¡°íšŒ
  const lastTask = await db.select({ taskId: tasks.taskId })
    .from(tasks)
    .where(like(tasks.taskId, `${prefix}-%`))
    .orderBy(desc(tasks.taskId))
    .limit(1);

  let nextNum = 1;
  if (lastTask.length > 0 && lastTask[0].taskId) {
    const lastNum = parseInt(lastTask[0].taskId.split('-').pop() || '0');
    nextNum = lastNum + 1;
  }

  return `${prefix}-${String(nextNum).padStart(3, '0')}`;
}
```

---

## 9. ë°ì´í„° ìš©ëŸ‰ ì¶”ì •

| í…Œì´ë¸” | ì˜ˆìƒ ë ˆì½”ë“œ/ì›” | ë ˆì½”ë“œ í¬ê¸° | ì›”ê°„ ìš©ëŸ‰ |
|--------|---------------|-------------|-----------|
| projects | ~5 | ~500B | ~2.5KB |
| tasks | ~100 | ~1KB | ~100KB |
| stage_gates | ~25 | ~500B | ~12.5KB |
| activity_log | ~500 | ~300B | ~150KB |
| api_usage | ~3,000 | ~200B | ~600KB |
| **í•©ê³„** | | | **~865KB/ì›”** |

> SQLite ë˜ëŠ” PostgreSQL ëª¨ë‘ ì¶©ë¶„íˆ ì²˜ë¦¬ ê°€ëŠ¥í•œ ê·œëª¨. 1ë…„ ìš´ì˜í•´ë„ ~10MB ìˆ˜ì¤€.

---

## 10. ì°¸ê³ ì‚¬í•­

- **Drizzle Push**: ê°œë°œ ì¤‘ì—ëŠ” `drizzle-kit push`ë¡œ ë¹ ë¥¸ ìŠ¤í‚¤ë§ˆ ë°˜ì˜
- **Drizzle Migrate**: í”„ë¡œë•ì…˜ì—ì„œëŠ” `drizzle-kit generate` â†’ `drizzle-kit migrate`ë¡œ ì•ˆì „í•œ ë§ˆì´ê·¸ë ˆì´ì…˜
- **Seed ë°ì´í„°**: ì´ˆê¸° í”„ë¡œì íŠ¸ ì½”ë“œ(KAN, FXT ë“±)ëŠ” seed ìŠ¤í¬ë¦½íŠ¸ë¡œ íˆ¬ì…
- **`graph_id` íê¸°**: ê¸°ì¡´ `tasks.graph_id`ëŠ” ì¹¸ë°˜ ì²´ê³„ì˜ `task_id`ë¡œ ëŒ€ì²´, ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ì œê±°
